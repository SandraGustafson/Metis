{% extends "bootstrap/base.html" %}

{% block title %}METIS{% endblock %}

{% block styles %}
{{super()}}
<style>
    body {
        padding: 20px;
        background-color: #f8f9fa;
    }
    .header {
        text-align: center;
        margin-bottom: 40px;
    }
    .search-container {
        max-width: 600px;
        margin: 0 auto;
        background-color: white;
        padding: 30px;
        border-radius: 10px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .artwork-card {
        margin-bottom: 30px;
        background-color: white;
        border-radius: 10px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        padding: 20px;
    }
    .artwork-image {
        max-width: 100%;
        height: auto;
        border-radius: 5px;
        margin-bottom: 15px;
    }
    .artwork-info {
        margin-top: 15px;
    }
    .loading {
        text-align: center;
        display: none;
    }
    #results {
        margin-top: 40px;
    }
    .source-tag {
        font-size: 0.8em;
        color: #666;
        font-style: italic;
    }
    .api-status {
        margin-top: 20px;
        font-size: 0.9em;
        color: #666;
    }
    .error-message {
        color: #721c24;
        background-color: #f8d7da;
        border: 1px solid #f5c6cb;
        padding: 10px;
        border-radius: 4px;
        margin: 20px 0;
    }
    .tags {
        margin-top: 10px;
        font-size: 0.9em;
    }
    .tags span {
        display: inline-block;
        background-color: #e9ecef;
        padding: 2px 8px;
        border-radius: 12px;
        margin-right: 5px;
        margin-bottom: 5px;
    }
</style>
{% endblock %}

{% block content %}
<div class="container">
    <div class="header">
        <h1>Art Education Resource Finder</h1>
        <p class="lead">Discover artwork that enhances your teaching themes</p>
    </div>

    <div class="search-container">
        <div class="input-group">
            <input type="text" 
                   class="form-control" 
                   id="theme" 
                   placeholder="Enter a theme (e.g., democracy, industrial revolution, nature)"
                   onkeypress="if(event.key === 'Enter') searchArtwork()">
            <div class="input-group-append">
                <button class="btn btn-primary" type="button" onclick="searchArtwork()">
                    Find Relevant Artwork
                </button>
            </div>
        </div>
    </div>

    <div class="loading" id="loading">
        <div class="spinner-border text-primary" role="status">
            <span class="sr-only">Loading...</span>
        </div>
        <p>Searching for artwork...</p>
    </div>

    <div id="error-container"></div>
    <div id="results"></div>
</div>
{% endblock %}

{% block scripts %}
{{super()}}
<script>
async function searchArtwork() {
    const themeInput = document.getElementById('theme');
    const theme = themeInput.value.trim();
    if (!theme) return;

    const loading = document.getElementById('loading');
    const results = document.getElementById('results');
    const errorContainer = document.getElementById('error-container');
    
    loading.style.display = 'block';
    results.innerHTML = '';
    errorContainer.innerHTML = '';

    // Create the request data
    const requestData = {
        theme: theme
    };
    
    try {
        // Make the request with explicit headers for Safari
        const response = await fetch('/search', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(requestData)
        });

        // Log request details for debugging
        console.log('Request:', {
            url: '/search',
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: requestData
        });

        if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.error || `Error: ${response.status}`);
        }

        const data = await response.json();
        loading.style.display = 'none';
        
        if (!data.results || data.results.length === 0) {
            results.innerHTML = `<div class="alert alert-info">No artwork found for this theme. Try a different search term.</div>`;
            return;
        }
        
        const artworksHTML = data.results.map(artwork => `
            <div class="artwork-card">
                ${artwork.image_url ? `
                    <img src="${artwork.image_url}" 
                         alt="${artwork.title || 'Artwork'}" 
                         class="artwork-image" 
                         onerror="this.style.display='none'">
                ` : ''}
                <div class="artwork-info">
                    <h3>${artwork.title || 'Untitled'}</h3>
                    ${artwork.artist ? `<p><strong>Artist:</strong> ${artwork.artist}</p>` : ''}
                    ${artwork.date ? `<p><strong>Date:</strong> ${artwork.date}</p>` : ''}
                    ${artwork.medium ? `<p><strong>Medium:</strong> ${artwork.medium}</p>` : ''}
                    ${artwork.culture ? `<p><strong>Culture:</strong> ${artwork.culture}</p>` : ''}
                    ${artwork.period ? `<p><strong>Period:</strong> ${artwork.period}</p>` : ''}
                    ${artwork.description ? `
                        <div class="description">
                            ${artwork.description.split('\n').map(paragraph => 
                                paragraph ? `<p>${paragraph}</p>` : ''
                            ).join('')}
                        </div>
                    ` : ''}
                    ${artwork.tags ? `
                        <div class="tags">
                            ${artwork.tags.split(',').map(tag => 
                                tag.trim() ? `<span>${tag.trim()}</span>` : ''
                            ).join('')}
                        </div>
                    ` : ''}
                    <p class="source-tag">
                        Source: ${artwork.source}
                        ${artwork.source_url ? `<a href="${artwork.source_url}" target="_blank">View more details</a>` : ''}
                    </p>
                </div>
            </div>
        `).join('');
        
        results.innerHTML = artworksHTML;
    } catch (error) {
        loading.style.display = 'none';
        errorContainer.innerHTML = `<div class="error-message">${error.message}</div>`;
        console.error('Error:', error);
    }
}
</script>
{% endblock %}
